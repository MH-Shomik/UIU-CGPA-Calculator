<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UIU CGPA Calculator with AI Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f4f8;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        .btn-primary {
            background-image: linear-gradient(to right, #4f46e5, #c026d3);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(116, 79, 168, 0.75);
        }
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px 0 rgba(116, 79, 168, 0.85);
        }
        .btn-secondary {
            background-image: linear-gradient(to right, #10b981, #3b82f6);
             transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(22, 163, 74, 0.5);
        }
        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px 0 rgba(22, 163, 74, 0.6);
        }
        .input-field {
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }
        .input-field:focus {
            background-color: white;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        .final-cgpa-display {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-image: linear-gradient(145deg, #4f46e5, #7c3aed);
            box-shadow: 0 10px 30px -10px rgba(79, 70, 229, 0.7);
            color: white;
            position: relative;
        }
        .final-cgpa-display .cgpa-value {
            font-size: 4.5rem;
            font-weight: 800;
            line-height: 1;
            background: -webkit-linear-gradient(#ffffff, #e2e8f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: pop-in 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @keyframes pop-in {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .final-cgpa-display .cgpa-label {
            font-weight: 500;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.8);
        }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 50; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            backdrop-filter: blur(5px);
        }
        .modal-backdrop.show { opacity: 1; visibility: visible; }
        .modal-content {
            background: white; padding: 2rem; border-radius: 1rem;
            width: 90%;
            transform: scale(0.9); transition: transform 0.3s ease;
        }
        #alertModal .modal-content {
             max-width: 500px;
        }
        /* --- FIX START: Styles for AI Modal --- */
        #aiPlanModal .modal-content {
            max-width: 42rem; /* Tailwind's max-w-2xl */
            display: flex;
            flex-direction: column;
            max-height: 85vh; /* Prevent modal from being taller than the screen */
        }
        #aiPlanContent {
            overflow-y: auto; /* Make the content area scrollable */
            flex-grow: 1;
        }
        #closeAiModalBtn {
            font-size: 2rem; /* Make close button bigger */
            line-height: 1;
            font-weight: bold;
            padding: 0 0.5rem;
            transition: transform 0.2s ease;
        }
        #closeAiModalBtn:hover {
            transform: scale(1.1) rotate(90deg);
        }
        /* --- FIX END --- */
        .modal-backdrop.show .modal-content { transform: scale(1); }
        .table-row:hover {
            background-color: #f7f8ff;
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            z-index: 10;
            position: relative;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-6 lg:p-8">
    <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100" style="z-index: -1;"></div>

    <main class="max-w-6xl w-full mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-800">
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">CGPA Calculator</span>
            </h1>
            <p class="text-lg text-gray-600 mt-2 font-medium">United International University (UIU)</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- Left Column: Input Forms -->
            <div class="lg:col-span-2 space-y-8">
                <div class="glass-card p-6 lg:p-8">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">Previous Records</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="existingCgpa" class="block text-sm font-medium text-gray-600 mb-1">Existing CGPA</label>
                            <input type="number" id="existingCgpa" placeholder="e.g., 3.5" step="0.01" class="input-field w-full px-4 py-2 rounded-lg">
                        </div>
                        <div>
                            <label for="existingCredits" class="block text-sm font-medium text-gray-600 mb-1">Credits Completed</label>
                            <input type="number" id="existingCredits" placeholder="e.g., 90" step="0.5" class="input-field w-full px-4 py-2 rounded-lg">
                        </div>
                    </div>
                </div>
                <div class="glass-card p-6 lg:p-8">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">Add New Course</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="courseName" class="block text-sm font-medium text-gray-600 mb-1">Course Name (Optional)</label>
                            <input type="text" id="courseName" placeholder="e.g., Data Structures" class="input-field w-full px-4 py-2 rounded-lg">
                        </div>
                        <div>
                            <label for="courseCredits" class="block text-sm font-medium text-gray-600 mb-1">Credits</label>
                            <input type="number" id="courseCredits" placeholder="e.g., 3" min="0.5" step="0.5" class="input-field w-full px-4 py-2 rounded-lg">
                        </div>
                        <div>
                            <label for="courseGrade" class="block text-sm font-medium text-gray-600 mb-1">Grade</label>
                            <select id="courseGrade" class="input-field w-full px-4 py-2 rounded-lg">
                                <option>A</option><option>A-</option><option>B+</option><option>B</option><option>B-</option><option>C+</option><option>C</option><option>C-</option><option>D+</option><option>D</option><option>F</option>
                            </select>
                        </div>
                        <button id="addCourseBtn" class="w-full btn-primary text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            Add Course
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Results and Course List -->
            <div class="lg:col-span-3 space-y-8">
                <div class="glass-card p-6 lg:p-8 flex flex-col items-center justify-center">
                    <div class="final-cgpa-display">
                        <span id="cgpaResult" class="cgpa-value">0.00</span>
                        <span class="cgpa-label">Final CGPA</span>
                    </div>
                    <button id="aiPlannerBtn" class="mt-6 btn-secondary text-white font-bold py-3 px-8 rounded-lg flex items-center justify-center gap-2">
                        ✨ Get AI Study Plan
                    </button>
                </div>
                <div class="glass-card p-6 lg:p-8">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                        <h2 class="text-2xl font-bold text-gray-700 text-center sm:text-left">New Courses Added</h2>
                        <button id="clearAllBtn" class="btn-primary bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm self-center sm:self-auto" style="background-image: linear-gradient(to right, #ef4444, #dc2626);">Clear All</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full" id="courseList">
                            <thead>
                                <tr>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Course</th>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Credits</th>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">Grade</th>
                                    <th class="p-3 text-right text-sm font-semibold text-gray-600 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <tr id="placeholderRow">
                                    <td colspan="4" class="p-12 text-center text-gray-500">
                                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" /></svg>
                                        <h3 class="mt-2 font-medium text-gray-800">No new courses</h3>
                                        <p class="text-sm text-gray-500">Add a course to see it here.</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="text-center mt-12 pb-4">
             <div class="glass-card inline-block p-4">
                 <h3 class="font-semibold text-gray-700 mb-2">Grading System</h3>
                 <div class="text-xs text-gray-600 grid grid-cols-5 sm:grid-cols-11 gap-x-4 gap-y-1">
                     <span><strong>A</strong>: 4.00</span><span><strong>A-</strong>: 3.67</span><span><strong>B+</strong>: 3.33</span><span><strong>B</strong>: 3.00</span><span><strong>B-</strong>: 2.67</span><span><strong>C+</strong>: 2.33</span><span><strong>C</strong>: 2.00</span><span><strong>C-</strong>: 1.67</span><span><strong>D+</strong>: 1.33</span><span><strong>D</strong>: 1.00</span><span><strong>F</strong>: 0.00</span>
                 </div>
             </div>
        </footer>
    </main>
    
    <!-- Modals -->
    <div id="alertModal" class="modal-backdrop">
        <div class="modal-content text-center mx-auto">
            <h3 id="alertModalTitle" class="text-xl font-bold text-gray-800 mb-2"></h3>
            <p id="alertModalMessage" class="text-gray-600 mb-6"></p>
            <div id="alertModalActions" class="flex justify-center gap-4"></div>
        </div>
    </div>
    
    <div id="aiPlanModal" class="modal-backdrop">
        <div class="modal-content text-left mx-auto">
            <div class="flex justify-between items-start mb-4 flex-shrink-0">
                <h3 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-green-500 to-blue-500 pr-4">✨ Your AI Study Plan</h3>
                <button id="closeAiModalBtn" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div id="aiPlanContent" class="prose max-w-none text-gray-700">
                <!-- AI content will be injected here -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const addCourseBtn = document.getElementById('addCourseBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const aiPlannerBtn = document.getElementById('aiPlannerBtn');
            const courseListBody = document.querySelector('#courseList tbody');
            const cgpaResultEl = document.getElementById('cgpaResult');
            const placeholderRow = document.getElementById('placeholderRow');
            const existingCgpaInput = document.getElementById('existingCgpa');
            const existingCreditsInput = document.getElementById('existingCredits');

            // --- State ---
            let courses = [];
            const gradePoints = {
                'A': 4.00, 'A-': 3.67, 'B+': 3.33,
                'B': 3.00, 'B-': 2.67, 'C+': 2.33,
                'C': 2.00, 'C-': 1.67,
                'D+': 1.33, 'D': 1.00, 'F': 0.00
            };

            // --- Modals ---
            const alertModal = document.getElementById('alertModal');
            const alertModalTitle = document.getElementById('alertModalTitle');
            const alertModalMessage = document.getElementById('alertModalMessage');
            const alertModalActions = document.getElementById('alertModalActions');
            const aiPlanModal = document.getElementById('aiPlanModal');
            const aiPlanContent = document.getElementById('aiPlanContent');
            const closeAiModalBtn = document.getElementById('closeAiModalBtn');

            const showModal = (title, message, actions) => {
                alertModalTitle.textContent = title;
                alertModalMessage.textContent = message;
                alertModalActions.innerHTML = '';
                actions.forEach(action => {
                    const button = document.createElement('button');
                    button.textContent = action.text;
                    button.className = action.class;
                    button.onclick = () => {
                        hideModal(alertModal);
                        if(action.callback) action.callback();
                    };
                    alertModalActions.appendChild(button);
                });
                alertModal.classList.add('show');
            };

            const hideModal = (modal) => modal.classList.remove('show');
            closeAiModalBtn.addEventListener('click', () => hideModal(aiPlanModal));
            
            // --- FIX: Close modal when clicking on the backdrop ---
            aiPlanModal.addEventListener('click', (e) => {
                if (e.target === aiPlanModal) { // Check if the click is on the backdrop itself
                    hideModal(aiPlanModal);
                }
            });

            // --- Core Functions ---
            const renderCourses = () => {
                courseListBody.innerHTML = ''; 
                if (courses.length === 0) {
                    if (!courseListBody.contains(placeholderRow)) {
                        courseListBody.appendChild(placeholderRow);
                    }
                } else {
                    courses.forEach((course, index) => {
                        const row = document.createElement('tr');
                        row.className = 'table-row transition-all duration-300';
                        row.innerHTML = `
                            <td class="p-3 whitespace-nowrap text-sm font-medium text-gray-800">${course.name || `Course ${index + 1}`}</td>
                            <td class="p-3 whitespace-nowrap text-sm text-gray-600">${course.credits}</td>
                            <td class="p-3 whitespace-nowrap text-sm text-gray-600 font-semibold">${course.grade}</td>
                            <td class="p-3 whitespace-nowrap text-right text-sm font-medium">
                                <button class="text-red-500 hover:text-red-700 font-bold remove-btn" data-index="${index}">Remove</button>
                            </td>
                        `;
                        courseListBody.appendChild(row);
                    });
                }
                calculateCGPA();
            };

            const calculateCGPA = () => {
                let newTotalCredits = courses.reduce((sum, course) => sum + course.credits, 0);
                let newTotalGradePoints = courses.reduce((sum, course) => sum + (course.credits * gradePoints[course.grade]), 0);

                const existingCgpa = parseFloat(existingCgpaInput.value) || 0;
                const existingCredits = parseFloat(existingCreditsInput.value) || 0;
                const existingTotalGradePoints = existingCgpa * existingCredits;

                const finalTotalCredits = existingCredits + newTotalCredits;
                const finalTotalGradePoints = existingTotalGradePoints + newTotalGradePoints;

                const cgpa = finalTotalCredits === 0 ? 0 : finalTotalGradePoints / finalTotalCredits;
                cgpaResultEl.textContent = isNaN(cgpa) ? '0.00' : cgpa.toFixed(2);
                
                cgpaResultEl.classList.remove('pop-in');
                void cgpaResultEl.offsetWidth;
                cgpaResultEl.classList.add('pop-in');
            };

            const handleAddCourse = () => {
                const nameInput = document.getElementById('courseName');
                const creditsInput = document.getElementById('courseCredits');
                const gradeInput = document.getElementById('courseGrade');
                const credits = parseFloat(creditsInput.value);

                if (isNaN(credits) || credits <= 0) {
                    showModal('Invalid Input', 'Please enter a valid number of credits.', [{text: 'OK', class: 'btn-primary text-white font-bold py-2 px-6 rounded-lg'}]);
                    return;
                }

                courses.push({ name: nameInput.value.trim(), credits, grade: gradeInput.value });
                
                nameInput.value = '';
                creditsInput.value = '';
                gradeInput.selectedIndex = 0;
                renderCourses();
            };
            
            const handleRemoveCourse = (event) => {
                if (event.target.classList.contains('remove-btn')) {
                    const index = parseInt(event.target.dataset.index, 10);
                    courses.splice(index, 1);
                    renderCourses();
                }
            };

            const handleClearAll = () => {
                if(courses.length === 0) return;
                showModal(
                    'Confirm Clear', 
                    'Are you sure you want to clear all new courses?', 
                    [
                        {text: 'Cancel', class: 'bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg'},
                        {text: 'Confirm', class: 'bg-red-500 text-white font-bold py-2 px-6 rounded-lg', callback: () => {
                            courses = [];
                            renderCourses();
                        }}
                    ]
                );
            };

            // --- Gemini API Function ---
            const getAIStudyPlan = async () => {
                if (courses.length === 0) {
                    showModal('No Courses', 'Please add at least one new course to get a study plan.', [{text: 'OK', class: 'btn-primary text-white font-bold py-2 px-6 rounded-lg'}]);
                    return;
                }

                aiPlanContent.innerHTML = '<div class="flex justify-center items-center p-8"><div class="spinner"></div><p class="ml-4">Generating your plan...</p></div>';
                aiPlanModal.classList.add('show');

                const finalCgpa = cgpaResultEl.textContent;
                const courseDetails = courses.map(c => `- ${c.name || 'Unnamed Course'}: ${c.credits} credits, Grade: ${c.grade}`).join('\n');

                const prompt = `
                    You are an expert academic advisor for a student at United International University (UIU).
                    The student has just calculated their new CGPA based on their recent semester.

                    Here is their data:
                    - Previous CGPA: ${existingCgpaInput.value || 'Not provided'}
                    - Previous Credits: ${existingCreditsInput.value || 'Not provided'}
                    - Final Calculated CGPA: ${finalCgpa}
                    - New courses this semester:
                    ${courseDetails}

                    Based on this information, provide a personalized, encouraging, and actionable study plan. Structure your response in Markdown format with the following sections:
                    1.  **Overall Performance Analysis:** Start with a brief, motivational analysis of their new CGPA.
                    2.  **Priority Subjects:** Identify 1-3 subjects where the student could improve the most (based on lower grades like C, D, F).
                    3.  **Actionable Study Strategies:** For each priority subject, provide 2-3 specific and creative study tips. (e.g., "For Data Structures, try visualizing algorithms on a whiteboard" instead of just "study more").
                    4.  **Sample Weekly Schedule:** Create a simple, balanced weekly study schedule in a Markdown table, allocating time for the new courses.

                    Keep the tone positive and empowering.
                `;

                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                // --- FIX: Use environment-managed API key ---
                const apiKey = "AIzaSyAOhRLlWI6tLP34lFMxLCJD8-aNVKhKQQU"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0].content.parts[0].text) {
                        // A simple markdown to HTML converter
                        let htmlContent = result.candidates[0].content.parts[0].text;
                        htmlContent = htmlContent
                            .replace(/### (.*)/g, '<h3 class="text-lg font-bold mt-4 mb-2">$1</h3>')
                            .replace(/## (.*)/g, '<h2 class="text-xl font-bold mt-6 mb-3">$1</h2>')
                            .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                            .replace(/\* ([^*]+)/g, '<li class="ml-5 list-disc">$1</li>')
                            .replace(/\|(.+)\|/g, (match, p1) => {
                                if (p1.includes('---')) return ''; // ignore table header separator
                                return `<tr>${p1.split('|').map(s => `<td class="p-2 border">${s.trim()}</td>`).join('')}</tr>`
                            })
                            .replace(/(<\/td><\/tr>)/g,'</tr>') // clean up empty cells from split
                            .replace(/(<tr>.*<\/tr>)+/g, (table) => {
                                // Assume first row is header
                                const firstRow = table.match(/<tr>.*?<\/tr>/)[0];
                                const header = firstRow.replace(/<td/g, '<th').replace(/<\/td>/g, '</th>');
                                const body = table.substring(firstRow.length);
                                return `<table class="w-full text-left border-collapse mt-4"><thead>${header}</thead><tbody>${body}</tbody></table>`
                            })
                            .replace(/\n/g, '<br>');


                        aiPlanContent.innerHTML = htmlContent;
                    } else {
                        aiPlanContent.innerHTML = '<p class="text-red-500">Sorry, something went wrong while generating the plan. Please try again.</p>';
                        console.error("Unexpected API response structure:", result);
                    }
                } catch (error) {
                    aiPlanContent.innerHTML = `<p class="text-red-500">Failed to connect to the AI service. Please check your connection and try again.</p><p class="text-xs text-gray-500 mt-2">${error}</p>`;
                    console.error("Error fetching AI plan:", error);
                }
            };

            // --- Event Listeners ---
            addCourseBtn.addEventListener('click', handleAddCourse);
            clearAllBtn.addEventListener('click', handleClearAll);
            aiPlannerBtn.addEventListener('click', getAIStudyPlan);
            courseListBody.addEventListener('click', handleRemoveCourse);
            existingCgpaInput.addEventListener('input', calculateCGPA);
            existingCreditsInput.addEventListener('input', calculateCGPA);

            renderCourses();
        });
    </script>
</body>
</html>
